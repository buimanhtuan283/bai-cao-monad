<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chơi Bài Cào (3 cây) - Monad Testnet</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background-color: #f4f7f6;
      margin: 0;
      padding: 20px;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #game-container {
        background-color: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 650px;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 25px;
    }
    .cards-area {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
      min-height: 60px;
      padding: 10px;
      background-color: #e8f5e9; /* Màu nền nhẹ cho khu vực bài */
      border-radius: 8px;
    }
    .hand {
      font-size: 1.1em;
      color: #388e3c; /* Màu xanh lá cây đậm hơn cho bài */
      font-weight: bold;
    }
    #player-hand, #dealer-hand {
      width: 45%;
      padding: 10px;
      border: 1px solid #c8e6c9;
      border-radius: 6px;
      background-color: #f1f8e9;
      min-height: 40px; /* Để không bị nhảy layout */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .hand-title {
        font-size: 0.9em;
        color: #555;
        margin-bottom: 5px;
    }
    button {
      padding: 12px 25px;
      margin: 10px 5px;
      background-color: #4CAF50; /* Màu xanh lá cây chính */
      color: white;
      border: none;
      border-radius: 25px; /* Bo tròn hơn */
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.25s ease, transform 0.1s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    button:hover {
      background-color: #43A047; /* Đậm hơn khi hover */
      transform: translateY(-1px);
    }
    button:active {
        transform: translateY(0px);
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    button:disabled {
      background-color: #a5d6a7; /* Nhạt hơn khi bị vô hiệu hóa */
      cursor: not-allowed;
      transform: translateY(0);
      box-shadow: none;
    }
    input[type="number"] {
      padding: 12px;
      margin: 10px 5px;
      border-radius: 25px; /* Bo tròn */
      border: 1px solid #ccc;
      font-size: 1em;
      width: calc(60% - 22px);
      max-width: 200px;
      text-align: center;
    }
    #result {
      font-weight: bold;
      margin-top: 20px;
      padding: 15px;
      background-color: #e3f2fd; /* Màu nền xanh dương nhạt */
      border: 1px solid #bbdefb;
      border-radius: 8px;
      min-height: 25px;
      line-height: 1.5;
      color: #1e88e5; /* Màu chữ xanh dương */
    }
    #wallet-info, #wallet-balance {
      font-size: 0.95em;
      color: #555;
      margin: 8px 0;
    }
    #disconnect-wallet {
        background-color: #f44336; /* Màu đỏ cho nút ngắt kết nối */
    }
    #disconnect-wallet:hover {
        background-color: #e53935;
    }
    hr {
        border: 0;
        height: 1px;
        background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0));
        margin: 25px 0;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border-left-color: #4CAF50;
      animation: spin 1s ease infinite;
      display: none; /* Ẩn ban đầu */
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <h1>Bài Cào Hồi Hộp - Monad Testnet</h1>
    <div id="wallet-status">
        <div id="wallet-info">Ví: Chưa kết nối</div>
        <div id="wallet-balance">Số dư ví: 0 MON</div>
        <button id="connect-wallet">Kết nối ví</button>
        <button id="disconnect-wallet" style="display:none;">Ngắt kết nối</button>
    </div>
    <hr>
    <div id="game-controls">
        <input type="number" id="bet-amount" placeholder="Cược (MON)" step="0.1" min="0.1" disabled>
        <button id="place-bet-button" onclick="placeBet()" disabled>Đặt Cược</button>
        <button id="deal-cards-button" onclick="dealCards()" disabled>Chia Bài</button>
    </div>
    <div class="cards-area">
        <div id="player-hand"><span class="hand-title">Bài Của Bạn</span><span class="hand"></span></div>
        <div id="dealer-hand"><span class="hand-title">Bài Nhà Cái</span><span class="hand"></span></div>
    </div>
    <div class="spinner" id="loading-spinner"></div>
    <div id="result">Vui lòng kết nối ví để bắt đầu trò chơi.</div>
    <hr>
    <button id="withdraw-funds-button" onclick="withdrawFunds()" disabled style="background-color: #757575;">Rút Quỹ (Owner)</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

  <script>
    let provider, signer, account, contract, rawProvider;
    let web3ModalInstance;
    let currentBetAmount = 0;

    // THAY ĐỊA CHỈ CONTRACT CỦA BẠN VÀO ĐÂY SAU KHI DEPLOY BaiCaoV5.sol
    const contractAddress = '0x4C660aE681D531498A06042a1F8F09f228b59349'; 
    const contractABI = [ // ABI của BaiCaoV5
        {"inputs":[],"stateMutability":"payable","type":"constructor"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"betAmount","type":"uint256"}],"name":"BetBeingResolved","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BetPlaced","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"betAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"payoutAmount","type":"uint256"},{"indexed":false,"internalType":"bool","name":"playerWon","type":"bool"}],"name":"BetResolved","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"by","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FundsWithdrawn","type":"event"},
        {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"activeBets","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"getContractBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"placeBet","outputs":[],"stateMutability":"payable","type":"function"},
        {"inputs":[{"internalType":"bool","name":"playerActuallyWonFromClient","type":"bool"}],"name":"resolveBet","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"stateMutability":"payable","type":"fallback"},
        {"stateMutability":"payable","type":"receive"}
    ];


    const monadTestnetChainIdDecimal = 10143;
    const monadTestnetChainIdHex = '0x279F';
    const monadTestnetRPC = 'https://testnet.monad.xyz/';
    const monadTestnetInfo = {
        chainId: monadTestnetChainIdHex,
        chainName: 'Monad Testnet',
        rpcUrls: [monadTestnetRPC],
        nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
        blockExplorerUrls: ['https://explorer.testnet.monad.xyz/'],
    };
    const loadingSpinner = document.getElementById('loading-spinner');

    function initWeb3Modal() {
        const providerOptions = {
          walletconnect: {
            package: WalletConnectProvider.default,
            options: { rpc: { [monadTestnetChainIdDecimal]: monadTestnetRPC } }
          },
        };
        web3ModalInstance = new Web3Modal.default({
          cacheProvider: true, providerOptions, theme: "light", disableInjectedProvider: false
        });
    }

    async function connectWallet() {
      if (!web3ModalInstance) {
        document.getElementById('result').innerText = 'Lỗi: Web3Modal chưa sẵn sàng.'; return;
      }
      try {
        document.getElementById('result').innerText = 'Đang chờ chọn ví...';
        rawProvider = await web3ModalInstance.connect();
        provider = new ethers.BrowserProvider(rawProvider);
        const network = await provider.getNetwork();

        if (network.chainId !== BigInt(monadTestnetChainIdDecimal)) {
          document.getElementById('result').innerText = 'Mạng không đúng. Yêu cầu chuyển/thêm Monad Testnet...';
          try {
            if (rawProvider.request) {
                await rawProvider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: monadTestnetChainIdHex }] });
            } else {
                alert('Vui lòng chuyển ví sang Monad Testnet (ID: 10143) và thử lại.'); throw new Error('Cần chuyển mạng thủ công.');
            }
            provider = new ethers.BrowserProvider(rawProvider); // Re-initialize
            const newNetwork = await provider.getNetwork();
            if (newNetwork.chainId !== BigInt(monadTestnetChainIdDecimal)) throw new Error('Chuyển mạng không thành công.');
          } catch (switchError) {
            if (switchError.code === 4902 && rawProvider.request) {
              try {
                await rawProvider.request({ method: 'wallet_addEthereumChain', params: [monadTestnetInfo] });
                provider = new ethers.BrowserProvider(rawProvider); // Re-initialize
                const newNetwork = await provider.getNetwork();
                if (newNetwork.chainId !== BigInt(monadTestnetChainIdDecimal)) throw new Error('Thêm mạng không thành công.');
              } catch (addError) { throw new Error(`Không thể thêm Monad Testnet: ${addError.message || 'Từ chối.'}`); }
            } else { throw new Error(`Không thể chuyển/thêm Monad Testnet: ${switchError.message || 'Từ chối/Không hỗ trợ.'}`); }
          }
        }
        signer = await provider.getSigner();
        account = await signer.getAddress();
        document.getElementById('wallet-info').innerText = `Ví: ${account.slice(0, 6)}...${account.slice(-4)}`;
        contract = new ethers.Contract(contractAddress, contractABI, signer);
        await updateBalance();
        document.getElementById('result').innerText = 'Kết nối ví thành công!';
        document.getElementById('connect-wallet').style.display = 'none';
        document.getElementById('disconnect-wallet').style.display = 'inline-block';
        enableGameControls();
        subscribeToProviderEvents();
      } catch (error) {
        document.getElementById('result').innerText = `Kết nối ví thất bại: ${error.message}`;
        console.error('Connection error:', error);
        await disconnectWallet(false);
      }
    }

    function subscribeToProviderEvents() {
        if (!rawProvider) return;
        rawProvider.on("accountsChanged", async (accounts) => {
            if (accounts.length === 0) { await disconnectWallet(); }
            else {
                account = accounts[0];
                signer = await provider.getSigner(account);
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                document.getElementById('wallet-info').innerText = `Ví: ${account.slice(0, 6)}...${account.slice(-4)}`;
                await updateBalance();
                document.getElementById('result').innerText = 'Tài khoản đã thay đổi.';
                enableGameControls();
            }
        });
        rawProvider.on("chainChanged", async (chainId) => {
            const newChainIdDecimal = parseInt(chainId, 16);
            if (newChainIdDecimal !== monadTestnetChainIdDecimal) {
                document.getElementById('result').innerText = `Đã chuyển sang mạng không hỗ trợ (ID: ${newChainIdDecimal}). Vui lòng chuyển lại Monad Testnet.`;
                await disconnectWallet();
            } else {
                provider = new ethers.BrowserProvider(rawProvider);
                signer = await provider.getSigner();
                account = await signer.getAddress();
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                await updateBalance();
                document.getElementById('result').innerText = 'Mạng đã xác nhận là Monad Testnet.';
                enableGameControls();
            }
        });
        rawProvider.on("disconnect", (error) => { console.log("Provider disconnected:", error); disconnectWallet(); });
    }

    async function disconnectWallet(clearCache = true) {
      if (rawProvider && typeof rawProvider.disconnect === 'function' && rawProvider.isWalletConnect) {
        await rawProvider.disconnect();
      }
      if (clearCache && web3ModalInstance) { await web3ModalInstance.clearCachedProvider(); }
      resetState();
      document.getElementById('result').innerText = 'Đã ngắt kết nối ví. Kết nối lại để chơi.';
    }

    function resetState() {
      provider = signer = account = contract = rawProvider = null;
      document.getElementById('wallet-info').innerText = 'Ví: Chưa kết nối';
      document.getElementById('wallet-balance').innerText = 'Số dư ví: 0 MON';
      document.querySelector('#player-hand .hand').innerText = '';
      document.querySelector('#dealer-hand .hand').innerText = '';
      document.getElementById('connect-wallet').style.display = 'inline-block';
      document.getElementById('disconnect-wallet').style.display = 'none';
      disableGameControls();
    }
    
    async function enableGameControls() {
        document.getElementById('bet-amount').disabled = false;
        document.getElementById('place-bet-button').disabled = false;
        // Nút deal-cards sẽ được enable sau khi đặt cược thành công
        document.getElementById('deal-cards-button').disabled = true; 
        if (contract && account) {
            try {
                const ownerAddress = await contract.owner();
                document.getElementById('withdraw-funds-button').disabled = ownerAddress.toLowerCase() !== account.toLowerCase();
            } catch (e) { document.getElementById('withdraw-funds-button').disabled = true; }
        } else { document.getElementById('withdraw-funds-button').disabled = true; }
    }

    function disableGameControls() {
        document.getElementById('bet-amount').disabled = true;
        document.getElementById('place-bet-button').disabled = true;
        document.getElementById('deal-cards-button').disabled = true;
        document.getElementById('withdraw-funds-button').disabled = true;
        document.getElementById('bet-amount').value = '';
    }

    document.getElementById('connect-wallet').addEventListener('click', connectWallet);
    document.getElementById('disconnect-wallet').addEventListener('click', () => disconnectWallet(true));

    async function updateBalance() {
      if (!account || !provider) { document.getElementById('wallet-balance').innerText = `Số dư ví: 0 MON`; return; }
      try {
        const walletBal = await provider.getBalance(account);
        document.getElementById('wallet-balance').innerText = `Số dư ví: ${parseFloat(ethers.formatEther(walletBal)).toFixed(4)} MON`;
      } catch (error) {
        document.getElementById('result').innerText = `Cập nhật số dư thất bại: ${error.message}`;
      }
    }

    async function withdrawFunds() {
      if (!account || !contract) { document.getElementById('result').innerText = 'Vui lòng kết nối ví!'; return; }
      loadingSpinner.style.display = 'block';
      document.getElementById('result').innerText = 'Đang xử lý yêu cầu rút tiền...';
      try {
        // Kiểm tra owner đã được thực hiện khi enable nút, nhưng kiểm tra lại cho chắc
        const ownerAddr = await contract.owner();
        if (ownerAddr.toLowerCase() !== account.toLowerCase()) {
            throw new Error("Chỉ chủ sở hữu mới được rút tiền!");
        }
        const tx = await contract.withdraw();
        document.getElementById('result').innerText = 'Giao dịch rút tiền đã gửi, đợi xác nhận...';
        await tx.wait();
        await updateBalance();
        document.getElementById('result').innerText = `Đã rút thành công quỹ về ví của Owner!`;
      } catch (error) {
        document.getElementById('result').innerText = `Lỗi khi rút tiền: ${error.message}`;
      } finally {
        loadingSpinner.style.display = 'none';
      }
    }

    const suits = ['♠', '♣', '♥', '♦'];
    const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    let deck = [], playerHand = [], dealerHand = [];

    function createDeck() { deck = []; for (let s of suits) for (let r of ranks) deck.push({ r, s }); }
    function shuffleDeck() { for (let i = deck.length - 1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]];}}
    function calculatePoints(hand) {
      let points = 0;
      for (let card of hand) {
        if (['K', 'Q', 'J'].includes(card.r)) points += 0; // K, Q, J là 0 điểm (hoặc 10 -> 0 nút)
        else if (card.r === 'A') points += 1;
        else points += parseInt(card.r);
      }
      return points % 10;
    }

    async function placeBet() {
      const betInput = document.getElementById('bet-amount').value;
      if (!account || !contract) { document.getElementById('result').innerText = 'Vui lòng kết nối ví!'; return; }
      if (betInput.trim() === '' || isNaN(parseFloat(betInput)) || parseFloat(betInput) <= 0) {
        document.getElementById('result').innerText = 'Số tiền cược không hợp lệ!'; return;
      }
      const bet = parseFloat(betInput);
      loadingSpinner.style.display = 'block';
      document.getElementById('result').innerText = 'Đang xử lý giao dịch đặt cược...';
      document.getElementById('place-bet-button').disabled = true;
      document.getElementById('deal-cards-button').disabled = true;

      try {
        const betInWei = ethers.parseEther(bet.toString());
        // Kiểm tra active bet trên contract trước khi đặt
        const currentActiveBet = await contract.activeBets(account);
        if (currentActiveBet > 0n) { // BigInt comparison
            throw new Error("Bạn đã có một lượt cược đang chờ xử lý trên contract. Hãy hoàn thành nó trước.");
        }

        const tx = await contract.placeBet({ value: betInWei });
        document.getElementById('result').innerText = 'Giao dịch đặt cược đã gửi, đợi xác nhận...';
        await tx.wait();
        currentBetAmount = bet; // Lưu số tiền đã cược thành công
        await updateBalance();
        document.getElementById('result').innerText = `Đã đặt cược ${bet} MON. Nhấn "Chia Bài"!`;
        document.getElementById('deal-cards-button').disabled = false; // Kích hoạt nút chia bài
      } catch (error) {
        document.getElementById('result').innerText = `Lỗi khi đặt cược: ${error.message}`;
        currentBetAmount = 0;
        document.getElementById('place-bet-button').disabled = false; // Cho phép thử lại
      } finally {
        loadingSpinner.style.display = 'none';
      }
    }

    async function dealCards() {
      if (!account || !contract) { document.getElementById('result').innerText = 'Vui lòng kết nối ví!'; return; }
      if (currentBetAmount <= 0) { document.getElementById('result').innerText = 'Vui lòng đặt cược trước!'; return; }

      loadingSpinner.style.display = 'block';
      document.getElementById('result').innerText = 'Đang chia bài... Xin chờ giây lát!';
      document.getElementById('deal-cards-button').disabled = true;
      document.getElementById('place-bet-button').disabled = true;
      document.querySelector('#player-hand .hand').innerText = '...';
      document.querySelector('#dealer-hand .hand').innerText = '...';

      try {
        createDeck(); shuffleDeck();
        playerHand = deck.splice(0, 3);
        dealerHand = deck.splice(0, 3);
        const playerPoints = calculatePoints(playerHand);
        const dealerPoints = calculatePoints(dealerHand);
        let playerActuallyWonClientSide = playerPoints > dealerPoints;

        document.getElementById('result').innerText = 'Đang xác nhận kết quả với blockchain...';
        const tx = await contract.resolveBet(playerActuallyWonClientSide);
        document.getElementById('result').innerText = 'Giao dịch đã gửi, chờ blockchain xác nhận kết quả...';
        await tx.wait();
        
        await updateBalance();

        let finalResultMessage = '';
        if (playerActuallyWonClientSide) {
            finalResultMessage = `BẠN THẮNG! Tiền thưởng đã được gửi vào ví!`;
        } else if (playerPoints < dealerPoints) {
            finalResultMessage = `NHÀ CÁI THẮNG! Chúc may mắn lần sau!`;
        } else {
            finalResultMessage = `HÒA! Tiền cược của bạn được giữ trong hợp đồng.`;
        }
        
        document.querySelector('#player-hand .hand').innerText = `${playerHand.map(c=>c.r+c.s).join(', ')} (${playerPoints} nút)`;
        document.querySelector('#dealer-hand .hand').innerText = `${dealerHand.map(c=>c.r+c.s).join(', ')} (${dealerPoints} nút)`;
        document.getElementById('result').innerText = finalResultMessage;
        
        currentBetAmount = 0;
        document.getElementById('place-bet-button').disabled = false;
        document.getElementById('bet-amount').value = '';
        // Nút deal-cards-button sẽ được kích hoạt lại sau khi đặt cược mới
      } catch (error) {
        document.getElementById('result').innerText = `Lỗi khi xử lý ván bài: ${error.message}. Vui lòng thử lại.`;
        console.error('Deal/Resolve error:', error);
        document.getElementById('deal-cards-button').disabled = false; // Cho phép thử lại nếu có lỗi nghiêm trọng
        document.getElementById('place-bet-button').disabled = false; 
      } finally {
        loadingSpinner.style.display = 'none';
      }
    }

    window.addEventListener('DOMContentLoaded', async () => {
        initWeb3Modal();
        disableGameControls();
        if (web3ModalInstance && web3ModalInstance.cachedProvider) {
            await connectWallet();
        } else {
             document.getElementById('result').innerText = 'Vui lòng kết nối ví để bắt đầu.';
        }
    });
  </script>
</body>
</html>
